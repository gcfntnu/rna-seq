#-*- mode: snakemake -*-
"""
Snakemake rules for aligning rna-seq fastq files to genome.


Dependencies
------------
STAR, https://github.com/alexdobin/STAR

Install:
conda -c bionconda install star

"""
import os

ALIGN_INTERIM = join(INTERIM_DIR, 'rnaseq', 'align')
ALIGN_PROCESSED = join(PROCESSED_DIR, 'rnaseq', 'align')

extra_conf_fn = srcdir('align.config')
if os.path.exists(extra_conf_fn):
    with open(extra_conf_fn) as fh:
        c  = yaml.load(fh) or {}
        update_config2(config, c)
        
def get_sorted_bam(wildcards):
    aligner = config.get('align', {}).get('method', 'star')
    return join(ALIGN_INTERIM, aligner, '{sample}.sorted.bam')

rule namesorted_bam:
    input:
       get_sorted_bam
    output:
        join(ALIGN_INTERIM, config.get('align', {}).get('method', 'star'), '{sample}.namesorted.bam')
    threads:
        4
    singularity:
        'docker://quay.io/biocontainers/sambamba:0.7.0--h89e63da_0'
    shell:
        'sambamba sort -N -p -m 24G -t {threads} -o {output} {input}'

include:
    'align/star.rules'  
include:
    'align/hisat2.rules'
include:
    'align/picardtools.rules'
